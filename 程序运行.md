# ç¨‹åºå¦‚ä½•è¿è¡Œï¼Ÿ

> * [X] 1  Cargo new
> * [X] 2  Makefile + Cargo.toml + .cargo/config.toml
> * [X] 3  src
> * [X] 4  make run

## æ‰¹å¤„ç†

> **RISC-V å¯„å­˜å™¨ç¼–å·å’Œåˆ«å**
> RISC-V å¯„å­˜å™¨ç¼–å·ä»`0~31`ï¼Œè¡¨ç¤ºä¸º`x0~x31`ã€‚å…¶ä¸­ï¼š
>
> * `x10~x17`ï¼šå¯¹åº”`a0~a7`
> * `x1`ï¼šå¯¹åº”`ra`

### USERç¨‹åº

```shell
user
    â”œâ”€â”€ .cargo
    â”‚   â””â”€â”€ config.toml   (è°ƒæ•´å†…å­˜å¸ƒå±€)
    â”œâ”€â”€ Cargo.lock
    â”œâ”€â”€ Cargo.toml
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ src
    â”‚   â”œâ”€â”€ bin           (å­˜æ”¾åº”ç”¨ç¨‹åº)
    â”‚   â”œâ”€â”€ lang_items.rs (panic)
    â”‚   â”œâ”€â”€ console.rs    (å…·ä½“åŠŸèƒ½ï¼Œwrite_str/......)
    â”‚   â”œâ”€â”€ lib.rs        (ç³»ç»ŸåŠŸèƒ½ï¼Œwrite/exit/......)
    â”‚   â”œâ”€â”€ syscall.rs    (ç³»ç»Ÿè°ƒç”¨ï¼Œ"ecall"->syscall->sys_*)
    â”‚   â””â”€â”€ linker.ld     (åº”ç”¨ç¨‹åºçš„å†…å­˜å¸ƒå±€)
    â””â”€â”€ target
        â”œâ”€â”€ .rustc_info.json
        â”œâ”€â”€ CACHEDIR.TAG
        â”œâ”€â”€ release
        â””â”€â”€ riscv64gc-unknown-none-elf
```

#### ğŸ‘€ï¸å†…å­˜å¸ƒå±€

> é¦–å…ˆåœ¨`user/src/linker.ld`æ–‡ä»¶ä¸­ç¼–å†™å¥½é“¾æ¥è„šæœ¬ï¼Œå†é€šè¿‡`user/.cargo/config`å»å£°æ˜ä½¿ç”¨é“¾æ¥è„šæœ¬

1. `user/src/linker.ld`

   ```linker
   OUTPUT_ARCH(riscv)
   ENTRY(_start)

   BASE_ADDRESS = 0x80400000;

   SECTIONS
   {
       . = BASE_ADDRESS;
       .text : {
           *(.text.entry)
           *(.text .text.*)
       }
       .rodata : {
           *(.rodata .rodata.*)
           *(.srodata .srodata.*)
       }
       .data : {
           *(.data .data.*)
           *(.sdata .sdata.*)
       }
       .bss : {
           start_bss = .;
           *(.bss .bss.*)
           *(.sbss .sbss.*)
           end_bss = .;
       }
       /DISCARD/ : {
           *(.eh_frame)
           *(.debug*)
       }
   }
   ```
2. `user/.cargo/config`

   ```toml
   [build]
   target = "riscv64gc-unknown-none-elf"

   [target.riscv64gc-unknown-none-elf]
   rustflags = [
       "-Clink-args=-Tsrc/linker.ld", "-Cforce-frame-pointers=yes"
   ]

   ```

#### ğŸ‘€ï¸ç³»ç»Ÿè°ƒç”¨

```rust
/// åŠŸèƒ½ï¼šå°†å†…å­˜ä¸­ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶ã€‚
/// å‚æ•°ï¼š`fd` è¡¨ç¤ºå¾…å†™å…¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼›
///      `buf` è¡¨ç¤ºå†…å­˜ä¸­ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼›
///      `len` è¡¨ç¤ºå†…å­˜ä¸­ç¼“å†²åŒºçš„é•¿åº¦ã€‚
/// è¿”å›å€¼ï¼šè¿”å›æˆåŠŸå†™å…¥çš„é•¿åº¦ã€‚
/// syscall IDï¼š64
fn sys_write(fd: usize, buf: *const u8, len: usize) -> isize;

/// åŠŸèƒ½ï¼šé€€å‡ºåº”ç”¨ç¨‹åºå¹¶å°†è¿”å›å€¼å‘ŠçŸ¥æ‰¹å¤„ç†ç³»ç»Ÿã€‚
/// å‚æ•°ï¼š`exit_code` è¡¨ç¤ºåº”ç”¨ç¨‹åºçš„è¿”å›å€¼ã€‚
/// è¿”å›å€¼ï¼šè¯¥ç³»ç»Ÿè°ƒç”¨ä¸åº”è¯¥è¿”å›ã€‚
/// syscall IDï¼š93
fn sys_exit(exit_code: usize) -> !;
```

```rust
fn program1() {//-bin-åº”ç”¨ç¨‹åº
    pub fn write_str() {//-console.rs-å…·ä½“åŠŸèƒ½
        pub fn write() {//-lib.rs-ç³»ç»ŸåŠŸèƒ½
            pub fn sys_write() {//-syscall.rs-ç³»ç»Ÿè°ƒç”¨
                pub fn syscall() {//-syscall.rs-ç³»ç»Ÿè°ƒç”¨
                    "ecall"; //æ±‡ç¼–
                }
            }
        }
    }
}
```


### OSå†…æ ¸

```shell
os
â”œâ”€â”€ .cargo
â”‚   â””â”€â”€ config.toml
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ Makefile
â”œâ”€â”€ build.rs
â”œâ”€â”€ scripts
â”‚   â””â”€â”€ qemu-ver-check.sh
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ main.rs
â”‚   â”œâ”€â”€ lang_items.rs  (panic)
â”‚   â”œâ”€â”€ batch.rs
â”‚   â”œâ”€â”€ console.rs
â”‚   â”œâ”€â”€ entry.asm
â”‚   â”œâ”€â”€ link_app.S
â”‚   â”œâ”€â”€ linker-qemu.ld
â”‚   â”œâ”€â”€ logging.rs
â”‚   â”œâ”€â”€ sbi.rs
â”‚   â”œâ”€â”€ sync
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ up.rs
â”‚   â”œâ”€â”€ syscall
â”‚   â”‚   â”œâ”€â”€ fs.rs
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ process.rs
â”‚   â””â”€â”€ trap
â”‚       â”œâ”€â”€ context.rs
â”‚       â”œâ”€â”€ mod.rs
â”‚       â””â”€â”€ trap.S
â””â”€â”€ target
```

#### ğŸš€ï¸å°†ç¨‹åºè¿æ¥åˆ°å†…æ ¸

> make runï¼š`Makefile`ä¼šè°ƒç”¨`build.rs`ç„¶åç”Ÿæˆæ–‡ä»¶`link_app.S`

```link
# os/src/link_app.S

    .align 3
    .section .data
    .global _num_app
_num_app:
    .quad 5
    .quad app_0_start
    .quad app_1_start
    .quad app_2_start
    .quad app_3_start
    .quad app_4_start
    .quad app_4_end

    .section .data
    .global app_0_start
    .global app_0_end
app_0_start:
    .incbin "../user/target/riscv64gc-unknown-none-elf/release/00hello_world.bin"
app_0_end:

    .section .data
    .global app_1_start
    .global app_1_end
app_1_start:
    .incbin "../user/target/riscv64gc-unknown-none-elf/release/01store_fault.bin"
app_1_end:

    .section .data
    .global app_2_start
    .global app_2_end
app_2_start:
    .incbin "../user/target/riscv64gc-unknown-none-elf/release/02power.bin"
app_2_end:

    .section .data
    .global app_3_start
    .global app_3_end
app_3_start:
    .incbin "../user/target/riscv64gc-unknown-none-elf/release/03priv_inst.bin"
app_3_end:

    .section .data
    .global app_4_start
    .global app_4_end
app_4_start:
    .incbin "../user/target/riscv64gc-unknown-none-elf/release/04priv_csr.bin"
app_4_end:
```


> OSå†…æ ¸ç¨‹åºè¦ä»main.rså¼€å§‹

```rust
use core::arch::global_asm;

global_asm!(include_str!("link_app.S"));
// åŠ è½½æ•´æ®µæ±‡ç¼– link_app.S
```
